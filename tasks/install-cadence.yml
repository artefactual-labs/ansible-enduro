
- name: Create the cadence group
  group:
    name: "{{ cadence_system_group }}"
    state: present
    system: true

- name: Create the cadence user
  user:
    name: "{{ cadence_system_user }}"
    groups: "{{ cadence_system_group }}"
    append: true
    shell: /usr/sbin/nologin
    system: true
    createhome: true
    home: /var/lib/cadence

- name: "Install cadence"
  yum:
    name: "https://jenkins-ci.archivematica.org/repos/am-packbuild/centos8-extras/cadence-0.9.5-1.el7.x86_64.rpm"
    state: present

- name: "Populate cadence database"
  mysql_db:
    name: "{{ cadence_db_name }}"
    state: import
    target: "{{ item }}"
  with_items:
    - /usr/share/cadence/migrations/cadence-migrations/v0.1/base.sql
  ignore_errors: true

- name: "Populate visibility database"
  mysql_db:
    name: "{{ cadence_visibility_db_name }}"
    state: import
    target: "{{ item }}"
  with_items:
    - /usr/share/cadence/migrations/visibility-migrations/v0.1/base.sql
  ignore_errors: true

- name: "SELinux: Allow nginx to use ports 8000 and 8001"
  become: "yes"
  seport:
    ports: "8020,8030"
    proto: "tcp"
    setype: "http_port_t"
    state: "present"
  when:
    - ansible_selinux is defined and ansible_selinux != False and ansible_selinux.status == 'enabled'
    - ansible_os_family == "RedHat"

